(()=>{"use strict";const e=async(e={})=>{const t=await fetch(`https://ws-server-23j4.onrender.com/${e.handle}`,{method:e.method,body:e.body});return await t.json().catch((()=>null))};class t{static async register(t,s){const r=JSON.stringify(t);s(await e({handle:"new-user",method:"POST",body:r}))}}class s{static createDate(){const e=new Date;let t=e.getHours(),s=e.getMinutes(),r=e.getDate(),n=e.getMonth()+1;return t=t<10?`0${t}`:t,s=s<10?`0${s}`:s,r=r<10?`0${r}`:r,n=n<10?`0${n}`:n,`${t}:${s} ${r}.${n}.${e.getFullYear()}`}static createUserCard(e){const t=document.createElement("div");t.classList.add("chat__user"),t.dataset.userId=e.id;const s=document.createElement("span");return s.textContent=e.name,t.append(s),t}static createMessageCard(e){const t=document.createElement("div");t.classList.add("message__container"),e.yourself?t.classList.add("message__container-yourself"):t.classList.add("message__container-interlocutor");const r=document.createElement("div");r.classList.add("message__header");const n=document.createElement("span"),a=s.createDate(),i=`${e.userName}, ${a}`;n.textContent=i;const o=document.createElement("div");return o.textContent=e.message,r.append(n),t.append(r,o),t}}const r=document.getElementById("root");new class{constructor(e){this.container=e,this.api=new t,this.websocket=null,this.userId=null,this.userName=null,this.registerPopup=this.container.querySelector(".register-popup"),this.registerError=this.registerPopup.querySelector(".register-error"),this.chatContainer=this.container.querySelector(".chat-container"),this.userList=this.chatContainer.querySelector(".chat__userlist"),this.messageList=this.container.querySelector(".chat__messages-container")}init(){this.subscribeOnEvents(),this.registerPopup.showModal()}subscribeOnEvents(){this.registerPopup.addEventListener("submit",(e=>{e.preventDefault(),this.registration(e.target),e.target.reset()})),this.chatContainer.addEventListener("submit",(e=>{e.preventDefault(),this.onSendMessage(e.target),e.target.reset()})),window.addEventListener("beforeunload",(()=>{this.websocket.send(JSON.stringify({type:"exit",user:{name:this.userName}}))}))}registration(e){const s=new FormData(e).get("name"),r={name:s};s?t.register(r,(e=>this.onEnterChatHandler(e))):console.log("Введите имя")}onEnterChatHandler(e){"error"!==e.status?(this.userId=e.user.id,this.userName=e.user.name,this.wsInit(),this.registerPopup.close()):this.registerError.textContent=e.message}onSendMessage(e){const t=new FormData(e).get("message").trim();if(!t)return;const s={type:"send"};s.userId=this.userId,s.userName=this.userName,s.message=t,this.websocket.send(JSON.stringify(s))}renderMessage(e){const t=e;e.userId===this.userId&&(t.userName="YOU",t.yourself=!0);const r=s.createMessageCard(t);this.messageList.append(r)}renderUsers(e){this.userList.replaceChildren(),e.forEach((e=>{const t=e;t.id===this.userId&&(t.name="YOU");const r=s.createUserCard(t);this.userList.append(r)}))}wsInit(){this.websocket=new WebSocket("wss://ws-server-23j4.onrender.com/ws"),this.websocket.addEventListener("open",(()=>{console.log("ws opened")})),this.websocket.addEventListener("close",(()=>{console.log("ws close")})),this.websocket.addEventListener("message",(e=>{this.onWsMessage(e)})),this.websocket.addEventListener("error",(()=>{console.log("ws error")}))}onWsMessage(e){const t=JSON.parse(e.data);t instanceof Array&&this.renderUsers(t),"send"===t.type&&this.renderMessage(t)}}(r).init()})();
//# sourceMappingURL=main.js.map